#include <signal.h>
#include <sys/time.h>

// estrutura que define um tratador de sinal (deve ser global ou static)
struct sigaction action ;

// estrutura de inicialização to timer
struct itimerval timer ;

/*unsigned int systime() {  //função já implementada pela libppos_static.a
    return systemTime;
}*/

void task_setprio (task_t *task, int prio) {
    if (prio > 20) {
        prio = 20;
    }
    else if (prio < -20) {
        prio = -20;
    }
    if (task == NULL) {
        task = taskExec;
        if (task == NULL) {
            return;
        }
    }
    task->staticPriority = prio;
    task->dynamicPriority = prio;
}

int task_getprio (task_t *task) {
    if (task == NULL) {
        task = taskExec;
        if (task == NULL) {
            return 0;
        }
    }
    return task->staticPriority;
}

task_t * scheduler() {
    // PRIOd scheduler
    if ( readyQueue == NULL ) {
        return NULL;
    }
    task_t *max = NULL;
    int maxPriority = 21;
    task_t *aux = readyQueue;
    do {
        int priority = aux->dynamicPriority;
        if (priority <= maxPriority) {
            max = aux;
            maxPriority = priority;
        }
        if (priority > -20) {
            (aux->dynamicPriority)--;
        }
        aux = aux->next;
    } while (aux != readyQueue);
    max->dynamicPriority = max->staticPriority;
    return max;
}

void tick_handler() {
    //PPOS_PREEMPT_DISABLE
    systemTime++;
    task_t *task = taskExec;
    if (preemption && task->userTask) {
        (task->quantum)--;
        if (task->quantum <= 0) {
            task->quantum = 20;
            task_suspend(task, &readyQueue);
            task_switch(taskDisp);
        }
    }
}

void update_task_cputime(task_t *task) {
    if (task == NULL) {
        return;
    }
    task->cpuTime += systemTime - task->lastSwitchDate;
    task->lastSwitchDate = systemTime;
}

void before_ppos_init () {
    // put your customization here
    systemTime = 0;
#ifdef DEBUG
    printf("\ninit - BEFORE");
#endif
}

void after_ppos_init () {
    // put your customization here
    // registra a ação para o sinal de timer SIGALRM
    action.sa_handler = tick_handler ;
    sigemptyset (&action.sa_mask) ;
    action.sa_flags = 0 ;
    if (sigaction (SIGALRM, &action, 0) < 0)
    {
        perror ("Erro em sigaction: ") ;
    }

    // ajusta valores do temporizador
    timer.it_value.tv_usec = 1000 ;      // primeiro disparo, em micro-segundos
    timer.it_value.tv_sec  = 0 ;      // primeiro disparo, em segundos
    timer.it_interval.tv_usec = 1000 ;   // disparos subsequentes, em micro-segundos
    timer.it_interval.tv_sec  = 0 ;   // disparos subsequentes, em segundos

    // arma o temporizador ITIMER_REAL (vide man setitimer)
    if (setitimer (ITIMER_REAL, &timer, 0) < 0)
    {
        perror ("Erro em setitimer: ") ;
    }
#ifdef DEBUG
    printf("\ninit - AFTER");
#endif
}

void before_task_create (task_t *task ) {
    // put your customization here
    task->staticPriority = 0;
    task->dynamicPriority = 0;
    task->userTask = 1;
    task->quantum = 20;
    task->creationDate = systemTime;
    task->lastSwitchDate = 0;
    task->cpuTime = 0;
    task->activations = 0;

    if (task == taskDisp) {
        task->userTask = 0;
    }
#ifdef DEBUG
    printf("\ntask_create - BEFORE - [%d]", task->id);
#endif
}

void after_task_exit () {
    // put your customization here
    task_t *task = taskExec;
    update_task_cputime(task);  //a tarefa termina antes de trocar para a proxima
    printf("Task %d exit: execution time %d ms, processor time %d ms, %d activations\n", task->id, systemTime - task->creationDate, task->cpuTime, task->activations);
#ifdef DEBUG
    printf("\ntask_exit - AFTER- [%d]", taskExec->id);
#endif
}

void before_task_switch ( task_t *task ) {
    // put your customization here
    update_task_cputime(taskExec);
    if (task == NULL) {
        return;
    }
    task->activations++;
    task->lastSwitchDate = systemTime;
#ifdef DEBUG
    printf("\ntask_switch - BEFORE - [%d -> %d]", taskExec->id, task->id);
    printf(" lastSwitchDate[%d]: %d ", task->id, task->lastSwitchDate);
#endif
}